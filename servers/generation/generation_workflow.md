# UltraRAG 生成（Generation）模块工作流程

## 生成模块工作流程图

```mermaid
flowchart TD
    subgraph 初始化阶段
        A[启动Generation模块] --> B[注册工具接口]
        B --> C[配置后端参数]
        C --> D{选择后端类型}
        D -->|vllm| E1[加载LLM模型与采样参数]
        D -->|openai| E2[初始化AsyncOpenAI客户端]
        D -->|hf| E3[加载HuggingFace模型与分词器]
    end

    subgraph 请求处理阶段
        F{接收请求类型}
        F -->|文本生成| G1[处理文本提示]
        F -->|多模态生成| G2[处理多模态输入]
        
        G1 --> H1[格式化提示消息]
        G2 --> H2[处理图像路径]
        H2 --> H3[转换为data URL]
        H3 --> H4[构建多模态消息]
        
        H1 --> I[调用后端生成]
        H4 --> I
    end

    subgraph 后端处理流程
        I --> J{选择后端处理}
        
        J -->|vllm后端| K1[调用model.chat]
        K1 --> K2[获取生成文本]
        
        J -->|openai后端| L1[设置并发控制]
        L1 --> L2[异步API调用]
        L2 --> L3[错误处理与重试]
        L3 --> L4[收集生成结果]
        
        J -->|hf后端| M1[应用chat模板]
        M1 --> M2[批量处理提示]
        M2 --> M3[调用模型生成]
        M3 --> M4[解码输出文本]
    end

    subgraph 结果处理与资源管理
        K2 --> N[返回生成结果]
        L4 --> N
        M4 --> N
        
        O[关闭模型请求] --> P{vllm后端?}
        P -->|是| Q1[调用模型关闭]
        P -->|否| Q2[跳过]
        Q1 --> Q3[释放GPU资源]
    end
```

## 流程说明

### 1. 初始化阶段
- **启动Generation模块**：创建Generation类实例并注册工具接口
- **配置后端参数**：接收backend_configs和sampling_params参数
- **后端选择与初始化**：
  - **vllm后端**：加载LLM模型，设置GPU可见性，配置张量并行度
  - **openai后端**：初始化AsyncOpenAI客户端，设置API参数和并发控制
  - **hf后端**：加载HuggingFace模型和分词器，处理特殊token

### 2. 请求处理阶段
- **文本生成请求**：
  - 提取和标准化文本提示
  - 添加系统提示（如果提供）
  - 构建对话消息结构
- **多模态生成请求**：
  - 处理图像路径列表
  - 将图像转换为data URL格式
  - 支持两种模式：
    - 标签模式：通过image_tag替换文本中的占位符
    - 附加模式：将图像直接附加到提示前

### 3. 后端处理流程
- **vllm后端**：直接调用model.chat方法，处理批处理请求
- **openai后端**：
  - 使用信号量控制并发请求数
  - 实现重试机制处理API错误
  - 异步收集生成结果
- **hf后端**：
  - 应用chat模板格式化提示
  - 批量处理提示以提高效率
  - 调用模型生成并解码输出

### 4. 结果处理与资源管理
- 返回生成的文本结果列表
- **模型关闭流程**（主要针对vllm）：
  - 调用适当的关闭方法
  - 清理模型引用
  - 收集垃圾并释放GPU内存

## 核心特性
- **多后端支持**：灵活支持本地和云端模型
- **异步处理**：特别是针对OpenAI后端的并发优化
- **错误处理**：包含API错误重试和异常捕获
- **资源管理**：合理分配GPU资源，支持模型优雅关闭
- **多模态支持**：处理文本和图像输入，支持不同的图像嵌入模式
